# DCPcrypt CI/CD Pipeline
# Builds and tests on Linux using a Docker image with Lazarus pre-installed

name: CI

on:
  push:
    branches: [ main, master, develop ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:  # Manual trigger

permissions:
  contents: write  # Required for creating releases

jobs:
  build-and-test:
    name: Build & Test (Linux)
    runs-on: ubuntu-latest
    container: wimmercg/lazarus-docker:1.2.0

    steps:
      - name: Install build tools
        run: |
          apt-get update
          apt-get install -y make git

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Verify FPC and Lazarus
        run: |
          fpc -iV
          lazbuild --version || lazbuildl64 --version || true

      - name: Build and run tests
        run: make check

      - name: Build examples
        run: make build-examples

  # Release job - triggered on version tags
  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [build-and-test]
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Extract version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          name: DCPcrypt v${{ steps.version.outputs.VERSION }}
          draft: false
          prerelease: false
          generate_release_notes: true
          body: |
            ## DCPcrypt Cryptographic Component Library v${{ steps.version.outputs.VERSION }}

            Lazarus / Free Pascal edition

            ### Installation

            **Option 1 - Packages (IDE)**

            1. Open `src/dcpcrypt.lpk` (runtime) and `src/dcpcrypt_laz.lpk` (design-time) in the Lazarus IDE
            2. Install them - cipher and hash components appear on the component palette

            **Option 2 - Direct use (no IDE)**

            Add `src/`, `src/Ciphers/` and `src/Hashes/` to your project unit search paths:

            ```bash
            fpc -Fupath/to/dcpcrypt-lazarus/src -Fupath/to/dcpcrypt-lazarus/src/Ciphers -Fupath/to/dcpcrypt-lazarus/src/Hashes myprogram.pas
            ```

            ### Quick Example

            ```pascal
            uses DCPrijndael, DCPsha256, DCPcrypt2, Classes, SysUtils;
            var
              Cipher: TDCP_rijndael;
            begin
              Cipher := TDCP_rijndael.Create(nil);
              Cipher.InitStr('my passphrase', TDCP_sha256);
              WriteLn(Cipher.EncryptString('Hello World'));
              Cipher.Burn;
              Cipher.Free;
            end.
            ```

            ### Documentation

            - [README](docs/README.md) - Full documentation
            - [Ciphers API](docs/Ciphers.md) - TDCP_cipher reference
            - [Block Ciphers API](docs/BlockCiphers.md) - TDCP_blockcipher reference
            - [Hashes API](docs/Hashes.md) - TDCP_hash reference

            ### Requirements

            - Free Pascal 3.2.0+ or Lazarus 2.0+
            - No external dependencies
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
